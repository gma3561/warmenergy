name: Process Form Submission and Notify

on:
  issues:
    types: [opened]

jobs:
  process-and-notify:
    runs-on: ubuntu-latest
    # form-submission ë¼ë²¨ì´ ìˆëŠ” ì´ìŠˆë§Œ ì²˜ë¦¬
    if: contains(github.event.issue.labels.*.name, 'form-submission') || contains(github.event.issue.labels.*.name, 'consultation')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Extract Form Data
      id: extract
      run: |
        # Issue bodyì—ì„œ ë°ì´í„° ì¶”ì¶œ
        echo "COMPANY=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=\*\*íšŒì‚¬ëª…:\*\* ).*')" >> $GITHUB_OUTPUT
        echo "NAME=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=\*\*ë‹´ë‹¹ìëª…:\*\* ).*')" >> $GITHUB_OUTPUT
        echo "PHONE=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=\*\*ì—°ë½ì²˜:\*\* ).*')" >> $GITHUB_OUTPUT
        echo "EMAIL=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=\*\*ì´ë©”ì¼:\*\* ).*')" >> $GITHUB_OUTPUT

    - name: Save to submissions.csv
      run: |
        # CSV íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
        if [ ! -f submissions.csv ]; then
          echo "ë‚ ì§œ,ì´ìŠˆë²ˆí˜¸,íšŒì‚¬ëª…,ë‹´ë‹¹ìëª…,ì—°ë½ì²˜,ì´ë©”ì¼,ë§í¬" > submissions.csv
        fi

        # ìƒˆë¡œìš´ ì œì¶œ ì¶”ê°€
        echo "$(date '+%Y-%m-%d %H:%M:%S'),#${{ github.event.issue.number }},${{ steps.extract.outputs.COMPANY }},${{ steps.extract.outputs.NAME }},${{ steps.extract.outputs.PHONE }},${{ steps.extract.outputs.EMAIL }},${{ github.event.issue.html_url }}" >> submissions.csv

    - name: Commit CSV
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add submissions.csv
        git diff --quiet && git diff --staged --quiet || git commit -m "ë¬¸ì˜ ì¶”ê°€: ${{ steps.extract.outputs.COMPANY }} - ${{ steps.extract.outputs.NAME }}"
        git push

    - name: Send Email Alert
      # Gmail SMTPë¥¼ ì‚¬ìš©í•œ ì´ë©”ì¼ ì „ì†¡ (ì„ íƒì‚¬í•­)
      # GitHub Secretsì— EMAIL_USERNAMEê³¼ EMAIL_PASSWORD ì„¤ì • í•„ìš”
      if: ${{ secrets.EMAIL_USERNAME != '' }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ${{ github.event.issue.title }}
        to: lucas@warmguys.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          ìƒˆë¡œìš´ ì „ê¸°ìš”ê¸ˆ ì ˆê° ì»¨ì„¤íŒ… ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

          ${{ github.event.issue.body }}

          ---
          ğŸ“ GitHub Issue: ${{ github.event.issue.html_url }}
          ğŸ• ì ‘ìˆ˜ ì‹œê°„: ${{ github.event.issue.created_at }}

    - name: Add Auto Reply
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤

ì•ˆë…•í•˜ì„¸ìš”, ${{ steps.extract.outputs.NAME }}ë‹˜.

ì „ê¸°ìš”ê¸ˆ ì ˆê° ì»¨ì„¤íŒ… ë¬¸ì˜ë¥¼ ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤.
ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹´ë‹¹ìê°€ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.

**ì ‘ìˆ˜ ì •ë³´:**
- ì ‘ìˆ˜ë²ˆí˜¸: #${{ github.event.issue.number }}
- íšŒì‚¬ëª…: ${{ steps.extract.outputs.COMPANY }}
- ì—°ë½ì²˜: ${{ steps.extract.outputs.PHONE }}

ì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì´ ì´ìŠˆì— ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.

ê°ì‚¬í•©ë‹ˆë‹¤.`
          })

    - name: Label and Close Issue
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            labels: ['form-submission', 'processed']
          })